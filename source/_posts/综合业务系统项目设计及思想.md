---
abbrlink: 0
---
# 综合业务系统项目框架设计





## 综合业务系统项目简介



整个项目分为**OTC管理系统**和**流程系统**两大块

流程项目负责OTC的会员，可转债，挂牌等申请流程走向

otc项目管理涉及业务逻辑



重要程度从高到低



1. **流程系统**
2. **可转债模块**
3. **挂牌模块**
4. **会员申请模块**
5. **角色权限模块**
6. 专家模块
7. 上会模块
8. 短信模块
9. pageoffice模块
10. 文件生成模块
11. 打包下载
12. 订单模块
13. 文件模块
14. 通知模块
15. 审核记录模块






## 整体框架设计



## 技术选型 



项目的技术栈，包括语言、框架和中间件等；

核心框架：Spring framework、SpringBoot

持久层框架：MyBatis Plus

日志管理：SLF4J、LogBack

分布式缓存：Redis

模块化管理：Maven

数据库连接池：Alibaba Druid

任务调度：quartz

客户端验证：JQuery Validation

配置中心: nacos

流程组件: flowable

其他插件: Pageoffice ,POI, Itext, lombok




## 接口设计











## 数据库设计



### mysql设计



### redis设计







### 技术选型：

项目的技术栈，包括语言、框架和中间件等；

分布式缓存：Redis

模块化管理：Maven

数据库连接池：Alibaba Druid

核心框架：Spring framework、SpringBoot

持久层框架：MyBatis Plus

任务调度：quartz

日志管理：SLF4J 1.7、LogBack

客户端验证：JQuery Validation

配置中心: nacos

流程组件: flowable

接口查看: swagger-ui

其他插件: Pageoffice,POI,Itext





### 本地构建：

本地开发需要启动的步骤 ；

- 配置数据库 默认需要vpn连接60的服务器
— 配置dev.properties下本地自定义配置及pageOffice配置
- 配置office 模板文件
- 配置本地的nacos配置文件
- 打mavenjar包为 dev




打包生产环境需要的命令

mvn clean install -Dmaven.test.skip=true  -Pprod



### 环境信息：

各个环境的访问方式，数据库连接等；

各种环境的配置请看 
application.properties

本地开发如果需要连接服务器的数据库需要登陆vpn

----- nacos 版本-----
上线nacos后需要登录nacos服务器来更改配置
nacos服务器在 bootstrap.properties 处配置





### 模块讲解：

核心的领域概念



用户管理：用户分为三种 承销商，OTC管理员，专家，是该系统的基础模块。

角色管理：承销商分三种角色 基础承销商 高级承销商 可转债承销商，OTC管理员分两种 后台管理员 审批管理员

权限管理：每个承销商可以设置其下属协同人员，公司风控，公司领导，OTC管理员后台可以设置审批人的部门及角色

部门管理：配置系统组织机构，可随意调整上下级。

日志管理：系统正常操作日志记录和查询；系统异常信息日志记录和查询。

连接池监视：监视当期系统数据库连接池状态，可进行分析SQL。

会员领域



- 权限管理这一块的问题
  之前有两套方案

1. 用户表sys_user关联岗位表job

2. 用户关联角色表 sys_user_role
   现在采用的是这一套方案

sys_user

Sys_user_role
   角色名称 role_id
   流程id flow_id

sys_role_permission
   role_id 角色id
   permission_id 权限id


sys_permission
   获取具体权限



可转债会员领域

可转债领域

挂牌领域

专家领域




### 数据模型:
数据库中的表目前分为几大类

- 以IPD 开头的 可转债模块



- 以 EIM 开头的 挂牌模块




- 以sys 开头的 系统模块


剩下的就是其他模块
其他模块又分为两大类

- 专家模块




- 会员模块



# 项目结构：

项目结构分为两大部分
1. 流程部分
    流程在zwkj.zhxt.flow包中

  

2. 业务部分
beans  枚举常量存放位置
common 框架基本配置, AOP, 异常存放点
config 项目配置包
controller 项目接口层
filter 入口拦截器, token校验, 幂等性校验, 接口防刷等等
flow 流程包
model 项目所有实体类
mvc 项目接口数据
utils  工具类
zhxtApplication.java  入口类 

# 技术架构：

见 参考图





# 部署架构：
部署架构图；







# 外部依赖：
项目运行时所依赖的外部集成方，

可转债模块  依赖  会员模块 和 专家模块

挂牌模块 依赖 会员模块 和 专家模块



   



# FAQ：
开发过程中常见问题的解答。

- 流程系统查看当前单子的审批人
```sql
SELECT NAME_,ASSIGNEE_ FROM ACT_RU_TASK WHERE PROC_INST_ID_ IN (SELECT PROC_INST_ID_ FROM `flowable`.`ACT_RU_EXECUTION` WHERE `BUSINESS_KEY_` LIKE '%34045882%');
```
- 统计专家会议
```sql
select EIM_base_info.enterprise_name , sys_attend.invite_name,sys_attend.meeting_time,sys_attend.meeting_local,sys_attend.batch from EIM_base_info, sys_attend where EIM_base_info.id = sys_attend.table_id  AND sys_attend.status not  in ('3','2') AND sys_attend.deleted = 1 and batch IS NOT NULL   and meeting_time is  NOT NULL and  meeting_time >= '2020-03-01 00:00' GROUP BY EIM_base_info.enterprise_name


```


- 当前流程任务不存在的问题
确定提交日期 -> 查看日志记录 -> 查看提交单子的接口

- 启动异常 .properties 报错
目前不存在这个问题 ,如果出现 是因为maven多环境配置的问题 
解决方案: 一般情况下重新选择环境打包就可以 

- 下载生成的文件 或者打包文件出现问题
一般是模板有问题或者模板未更新 
解决方案: 找到相对于的模板去更新下
如果更新后模板还是有问题需要去ExcelManage 199 行找出确定哪个字段有问题 在对应解决

-  CheckException: 系统错误
这个是flow流程系统报错后综合系统自定义的错误提示 当出现这个问题后需要查看所调用的 流程系统 接口以及数据是否正常 是否出现为空或者重复的问题 
解决方案: 通用错误一般是流程发生报错

- 获取excel 数据报错, 已经赋值为空 !
这是一个error告警 是因为你的数据不存在 我们默认赋值成空 但也有一些例外 只需注意就好



- 任务审批或者提交单据之后发现单子还在本人这里
这个问题比较复杂 需要确定很多地方
1. 查看单子状态是否有变更 
如果单子状态改变 -> 查看流程是否走到下一个角色那里 
               -> 走到下一个角色 说明流程没问题 ,单子状态有问题 
               解决方案: 查询但是为什么没有更改 找对应的接口
               -> 没有走到下一个角色  说明流程没有被调用 
               解决方案: 查看日志 是否报错 查看接口参数返回是否正常

如果单子状态没有改变 -> 说明流程报错或者在调用流程之前报错事物回滚导致状态没有变化
                  -> 如果流程报错查看日志 及审批人是否是登录角色
                  
- 提交多次失败
有两种情况
1. 提交流程成功了但是后续逻辑判断出错导致异常 这个问题有一个明显的状况就是下个角色可以看到多条单据任务 
    -> 当出现多条单据的时候 查看是否是状态没有改变导致的可以反复提交同一条单据  
    解决方案: 更改单子状态

2. 在调用流程之前或者调用流程出错导致的提价失败
   -> 查看业务逻辑错误  
   解决方案: 查询是否是因为更改流程导致
   
   
   
   
- 提交报错后流程无法流转的问题
这个bug是因为当前登录的提交人的手机号和流程当中的审批人手机号不是一个手机号 导致在提交的时候无法查询到当前登录人的任务
解决方案: 将当前登录人的手机号设置为流程的ASSIGNEE_ 审批人 
​```sql
SELECT NAME_,ASSIGNEE_ FROM ACT_RU_TASK WHERE PROC_INST_ID_ IN (SELECT PROC_INST_ID_ FROM `flowable`.`ACT_RU_EXECUTION` WHERE `BUSINESS_KEY_` LIKE '%34045882%');

```


- 完成任务后任务已经流转但是审批人名下还有一个单子(重复单子)
这个bug是犹豫多次提交引起的 查询提交是否是多次提交 或者是一次提交ID重复的问题
解决方案 调用swagger上的reject接口 taskid参数传 
​```sql
SELECT ID_ FROM ACT_RU_TASK WHERE PROC_INST_ID_ IN (SELECT PROC_INST_ID_ FROM `flowable`.`ACT_RU_EXECUTION` WHERE `BUSINESS_KEY_` LIKE '%34045882%');
​```

- 其他问题直接看日志错误代码及代码行号定位


- 常规单子状态和流程任务不对等的情况下的问题排查及解决方案

我们用一个生产环境出现问题的单子来举例说明

问题: 
单据状态本来应该是17,但是数据库显示当前单据的状态是16.8,
16.8的角色下没有查询到任务.

解决思路:
查询该单据数据库的update_time
SQL update time
2020-06-09 13:24:32

生产环境日志查询发现在
117870 2020-06-09 12:24:29.556
状态 修改过 变为 17

由以上两个时间节点可以得出 在12:24:29--13:24:32 期间肯定出现了问题,并且将状态变更为16.8

所以我们查询将状态变更为16.8的日志记录 关键字 "status":"16.8" 
121296 2020-06-09 13:24:32
发现状态变为status16.8

第一次16.8为双审的第一个人的记录"状态"没问题
接下来往后翻日志发现
121720行 2020-06-09 13:28:01.544
认领了任务

然后在日志记录的时候发现该角色短时间内操作了两次审批记录

第一次在 121255 行
第二次在 121244 行

这是请求参数 将状态由16.8变更为17
2020-06-09 13:24:32.359 |-INFO  [qtp593103894-12503] [1968791269_381917] com.zwkj.zhxt.common.ControllerAOP [74] -| 5. 请求参数 : {"admissionId":21551591,"evalute":"       已生成挂牌协议","ids":[],"key":"1","name":"张志波","questionList":[],"sort":500,"status":"17","sysUser":"zhangzhibo","taskId":"cb4c0394-a947-11ea-a656-0050568f1897",       "verifyRole":"user0","words":"生成挂牌协议"}

然后去流程业务日志中查询发现请求只收到一次
flow 
37773

了解综合系统处理流程发现问题出在 
判断redis缓存中是否有该单据的审核记录 如果有一个人审核则状态变为17 "并且删除当前缓存"  如果没有则16.8

因为第二个人操作了两次 所以
第一次发现有人审批 审核状态变为17 "并且删除当前缓存" 任务完成 
第二次发现缓存没有人审批过然后状态变为16.8 

所以会出现 单子是16.8 任务在17这个角色下.

- 查看专家替换选不出来的问题

主要sql

替换 table_id , organization_category,organization_categoryvice 这三个内容可以查看替换时专家的筛选人员
​```sql

SELECT
   *
FROM
   professor a
WHERE
   NOT EXISTS (
      SELECT
         *
      FROM
         sys_attend b
      WHERE
         a.id = b.professor_id
         AND b. `type` = 1
         AND b.table_id = 35932873
         AND b.deleted = 1)
      AND a.polling_status IN(1, 0)
      AND a.status = 1
      AND(a.Member_category = 1
         OR a.Member_category = 3)
      and(organization_category in(4, 7, 9, 10, 11)
         OR organization_categoryvice in(4, 7, 9, 10, 11)
         AND(organization_category NOT in(1)
            AND organization_categoryvice NOT in(1)))

SELECT
         *
      FROM
         sys_attend b
      WHERE
--           a.id = b.professor_id
          b. `type` = 1
         AND b.table_id = 35932873
         AND b.deleted = 1

```



## 下面是项目启动后需要用到的各种文件及地址



### 测试环境地址

测试流程查看(失效): http://192.168.0.60:8085/zhxtflow/app/processDiagram?processId=

测试swagger(失效): http://192.168.0.60:8085/zhxtflow/swagger-ui.html

测试流程图编辑(失效): http://192.168.0.60:8085/zhxtflow/modeler/index.html

测试环境zhxt-swagger: http://192.168.0.60:8086/zhxtotc/swagger-ui.html#/



### 预生产地址

预生产环境后端zhxt:  http://58.144.147.65:81/zhxtotc

预生产流程图 http://10.110.14.66:8085/zhxtflow/modeler/index.html#/processes

// 废弃  生产流程图: http://10.110.14.71:8085/zhxtflow/swagger-ui.html



### 生产环境地址(临时地址 后续取消)

生产环境流程图编辑: http://10.110.14.73:8085/zhxtflow/modeler/index.html#/processes


生产环境流程图查看: http://10.110.14.73:8085/zhxtflow/app/processDiagram?processId=

生产环境流程swagger: http://10.110.14.73:8085/zhxtflow/swagger-ui.html 





### 附带其他文档说明



查看所有流程的状态及角色以及附带后端接口的文档

流程状态梳理表V2.0.xlsx



所有角色权限配置文档

股转中心角色权限对应表.xlsx



综合业务需求说明文档

重庆股转中心综合业务系统产品需求说明书v0.6 8-13.docx



综合业务系统数据字典结构表

综合系统-数据字典V1.27.docx



截止一期项目压力测试报告

压力测试报告.docx



